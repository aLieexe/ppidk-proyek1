- name: Ensure /etc/audit/rules.d exists
  ansible.builtin.file:
    path: /etc/audit/rules.d
    state: directory
    mode: "0755"
    owner: root
    group: root

- name: Enable auditd syslog plugin
  ansible.builtin.lineinfile:
    dest: /etc/audit/plugins.d/syslog.conf
    regexp: ^active
    line: active = yes
    state: present
    mode: "0640"
    create: true

- name: Add auditd rules
  ansible.builtin.template:
    src: "hardening.rules.j2"
    dest: /etc/audit/rules.d/hardening.rules
    backup: true
    mode: "0600"
    owner: root
    group: root

- name: Restart auditd
  systemd:
    name: auditd
    state: restarted

- name: Configure Debian auditd GRUB cmdline
  ansible.builtin.lineinfile:
    line: GRUB_CMDLINE_LINUX="$GRUB_CMDLINE_LINUX audit=1 audit_backlog_limit=8192"
    regexp: "^GRUB_CMDLINE_LINUX="
    dest: /etc/default/grub.d/99-hardening-audit.cfg
    state: present
    create: true
    mode: "0640"
    owner: root
    group: root
  when:
    - ansible_facts.os_family == "Debian"

- name: Update GRUB
  become: true
  ansible.builtin.command:
    cmd: update-grub
  register: update_grub
  changed_when: update_grub.rc == 0