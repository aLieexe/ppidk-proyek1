- name: Install SELinux package
  ansible.builtin.package:
    pkg: "{{ selinux_package }}"
    state: present

- name: Run selinux-activate (Debian-family)
  ansible.builtin.command: selinux-activate
  tags:
  - molecule-idempotence-notest

- name: Put SELinux in {{ selinux_state }} mode
  ansible.posix.selinux:
    policy: "{{ selinux_policy }}"
    state: "{{ selinux_state }}"
  register: selinux_config

# This require some reading comprehension, please refer to https://docs.redhat.com/en/documentation/red_hat_enterprise_linux/7/html/selinux_users_and_administrators_guide/part_ii-managing_confined_services
- name: Ensure httpd can connect to the network.
  ansible.posix.seboolean:
    name: httpd_can_network_connect
    state: "{{ selinux_httpd_can_network_connect | ternary('yes', 'no') }}"
    persistent: yes
  when: ansible_selinux.status == 'enabled'

- name: Reboot to apply SELinux configuration
  ansible.builtin.reboot:
  tags:
  - molecule-notest
  when: selinux_config.reboot_required
